Bootstrap: docker
From: nvidia/cuda:11.7.1-devel-ubuntu22.04

%setup
    mkdir -p $APPTAINER_ROOTFS/root/.conda
    mkdir -p $APPTAINER_ROOTFS/env-setup
    mkdir -p $APPTAINER_ROOTFS/code-dir
    mkdir -p $APPTAINER_ROOTFS/data-dir
    mkdir -p $APPTAINER_ROOTFS/runs-dir

%post -c /bin/bash
    # Set noninteractive mode
    export DEBIAN_FRONTEND=noninteractive

    # Update and install necessary packages
    apt update && \
    apt install -y \
        wget git net-tools vim curl build-essential x11vnc zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev libssl-dev \
        libreadline-dev libffi-dev libsqlite3-dev libbz2-dev liblzma-dev freeglut3-dev && \
        # Install additional libraries for OpenCV (uncomment if not needed)
        apt install -y --no-install-recommends libglib2.0-0 libxrender1 libxext6 libsm6 libgl1-mesa-glx && \
    apt clean && \
    rm -rf /var/lib/apt/lists/*

    # Install Miniconda
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh && \
    bash Miniconda3-latest-Linux-x86_64.sh -b -p /root/miniconda3 && \
    rm -f Miniconda3-latest-Linux-x86_64.sh && \
    echo "Miniconda installed: $(/root/miniconda3/bin/conda --version)"

    # Add conda to PATH
    echo 'export PATH="/root/miniconda3/bin:${PATH}"' >> ~/.bashrc
    eval "$(/root/miniconda3/bin/conda shell.bash hook)"
    source /root/miniconda3/etc/profile.d/conda.sh
    conda init bash

    # Initialize Conda and set up environment
    conda create -n gdiff python=3.8 -y
    conda activate gdiff
    pip install --upgrade pip
    conda install -y pytorch==2.0.1 torchvision==0.15.2 pytorch-cuda=11.7 -c pytorch -c nvidia
    pip install "git+https://github.com/facebookresearch/pytorch3d.git@stable"

    # Install additional Python packages from requirements.txt
    conda install -c conda-forge suitesparse==5.10.1 scikit-sparse==0.4.8
    pip install -e /code-dir

    # Clone and install the mesh_to_sdf package
    cd /env-setup && \
    git clone https://github.com/robotgradient/mesh_to_sdf.git && \
    pip install -e mesh_to_sdf

%environment
    # Add conda to PATH and activate environment
    export PATH="/root/miniconda3/bin:${PATH}"

%runscript
    # Default entry point
    exec /root/miniconda3/bin/conda run --no-capture-output -n gdiff /bin/bash -c "$@"

%startscript
    # Start script for the container
    exec /root/miniconda3/bin/conda run --no-capture-output -n gdiff /bin/bash -c "$@"

%labels
    Author Talha
    Version 1.0
    Description "Apptainer for GraspDiffusion with PyTorch (GPU)"
